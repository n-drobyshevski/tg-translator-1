<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Edit Prompt Template</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .btn-back {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-radius: 50px;
        padding: 0.5rem 1rem;
      }
     
      #loading_spinner {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto mt-6 px-4">
      <div class="flex items-center mb-4">
        {% set href = '/admin/config' %}
        {% include 'components/back_button.html' %}
        <h1 class="text-2xl font-bold mb-0">Edit Prompt Template</h1>
      </div>
      <!-- Prompt Template Card -->
      <div class="bg-white shadow rounded p-6 mb-8">
        <form id="save_form">
          <div class="mb-4">
            <label class="block font-medium mb-1" for="prompt_text">Prompt Template</label>
            <textarea class="w-full border rounded px-3 py-2" name="prompt_text" id="prompt_text" rows="10">{{ current_prompt }}</textarea>
          </div>
          <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded" id="save_template_btn" name="action" value="save_prompt">Save Template</button>
        </form>
        <p class="text-gray-500 text-sm mt-4">Edit the prompt template above and click "Save Template" to update the translation prompt.</p>
      </div>
      <!-- Confirmation Modal -->
      <div id="confirmSaveModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
          <div class="flex justify-between items-center border-b px-4 py-2">
            <h5 class="text-lg font-semibold">Confirm Save</h5>
            <button type="button" class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="document.getElementById('confirmSaveModal').classList.add('hidden')">&times;</button>
          </div>
          <div class="px-4 py-4">
            Are you sure you want to save the template?
          </div>
          <div class="flex justify-end gap-2 border-t px-4 py-2">
            <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition" onclick="document.getElementById('confirmSaveModal').classList.add('hidden')">Cancel</button>
            <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition" id="confirm_save_btn">Confirm</button>
          </div>
        </div>
      </div>
      <!-- Toast for success pop up -->
      <div id="successToast" class="fixed top-5 right-5 z-50 hidden bg-green-500 text-white px-4 py-2 rounded shadow">
        Template saved successfully. Please reload the task for changes to take effect.
        <button type="button" class="ml-2 text-white hover:text-gray-200 font-bold" onclick="document.getElementById('successToast').classList.add('hidden')">&times;</button>
      </div>
      <hr class="my-6">
      <!-- Test Translation Card -->
      <div class="bg-white shadow rounded p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Test Translation</h2>
        <div class="flex flex-col md:flex-row gap-6">
          <!-- Input column -->
          <div class="md:w-1/2">
            <form method="POST" action="/admin/test_translation" class="inline" id="translation_form">
              <div class="mb-3">
                <label class="block font-medium mb-1" for="test_message">Type to Translate</label>
                <textarea class="w-full border rounded px-3 py-2" name="test_message" id="test_message" rows="10" style="height: 300px;" placeholder="Enter message to translate...">{{ sample_data|default("") }}</textarea>
              </div>
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" id="translate_button">Translate</button>
              <button type="button" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded ml-2" id="clear_test_message">Clear</button>
            </form>
            <form method="POST" action="/admin/get_last_telegram_post" class="inline">
              <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">Retrieve Last Telegram Post</button>
            </form>
          </div>
          <!-- Output column -->
          <div class="md:w-1/2 relative">
            <label class="block font-medium mb-1">Translated Result</label>
            <div class="border rounded bg-gray-50 p-3 h-[300px] overflow-y-auto" id="translation_result">
              {% if translation_result %}
                <p>{{ translation_result|safe }}</p>
              {% else %}
                <p class="text-gray-400">Translation result will appear here.</p>
              {% endif %}
            </div>
            <!-- Clear Result Button -->
            <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded absolute bottom-2 right-2" id="clear_translation_result">Clear Result</button>
          </div>
        </div>
        <p class="text-gray-500 text-sm mt-4">Use this section to test your prompt template. Enter a message and click "Translate" to see the result.</p>
      </div>
    </div>
    <!-- Spinner -->
    <div id="loading_spinner">
      <div class="bg-blue-100 border border-blue-300 text-blue-700 px-4 py-2 rounded flex items-center gap-2">
        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span>Translating... Please wait.</span>
      </div>
    </div>
    <div style="height: 25px;"></div>
    <script>
      // Clear the translation message field on button click
      document.getElementById('clear_test_message').addEventListener('click', function(){
        document.getElementById('test_message').value = '';
      });

      // Clear the translation result field on button click
      document.getElementById('clear_translation_result').addEventListener('click', function(){
        document.getElementById('translation_result').innerHTML = '<p class="text-gray-400">Translation result will appear here.</p>';
      });

      // Show spinner when the Translate form is submitted
      document.getElementById('translation_form').addEventListener('submit', function(event) {
        event.preventDefault();
        document.getElementById('loading_spinner').style.display = 'block';
        this.submit();
      });

      // Show confirmation modal when Save Template is clicked
      document.getElementById('save_template_btn').addEventListener('click', function(){
        document.getElementById('confirmSaveModal').classList.remove('hidden');
      });

      // On confirm in modal, perform AJAX call to save the prompt
      document.getElementById('confirm_save_btn').addEventListener('click', function(){
        document.getElementById('confirmSaveModal').classList.add('hidden');
        var formData = new FormData(document.getElementById('save_form'));
        fetch('/admin/save_prompt', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if(data.message) {
            // Show success toast
            var toastEl = document.getElementById('successToast');
            toastEl.classList.remove('hidden');
            setTimeout(function(){ toastEl.classList.add('hidden'); }, 4000);
          } else if(data.error) {
            alert("Error: " + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert("An error occurred while saving the template.");
        });
      });
    </script>
  </body>
</html>
