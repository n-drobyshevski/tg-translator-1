<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Edit Prompt Template</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
      .btn-back {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-radius: 50px; /* Makes the button round */
        padding: 0.5rem 1rem; /* Adjust padding for better appearance */
      }
      .btn-back svg {
        width: 1rem;
        height: 1rem;
      }
      #loading_spinner {
        position: fixed; /* Fixed position to stay at the top of the visible screen */
        top: 10px; /* Adjusted to be at the top of the visible screen */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050; /* Ensure it appears above other elements */
        display: none; /* Initially hidden */
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <div class="d-flex align-items-center mb-3">
        <a class="btn btn-outline-secondary btn-back me-3" href="/admin">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>

        </a>
        <h1 class="mb-0">Edit Prompt Template</h1>
      </div>
      <form id="save_form">
        <div class="mb-3">
          <label class="form-label" for="prompt_text">Prompt Template</label>
          <textarea class="form-control" name="prompt_text" id="prompt_text" rows="10">{{ current_prompt }}</textarea>
        </div>
        <button type="button" class="btn btn-primary" id="save_template_btn" name="action" value="save_prompt">Save Template</button>
      </form>
      <!-- Confirmation Modal -->
      <div class="modal fade" id="confirmSaveModal" tabindex="-1" aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmSaveModalLabel">Confirm Save</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to save the template?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="confirm_save_btn">Confirm</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Toast for success pop up -->
      <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; display: none;">
        <div class="d-flex">
          <div class="toast-body">
            Template saved successfully. Please reload the task for changes to take effect.
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
      <hr>
      <h2>Test Translation</h2>
      <div class="row">
        <!-- Input column -->
        <div class="col-md-6">
          <form method="POST" action="/admin/test_translation" class="d-inline" id="translation_form">
            <div class="mb-3">
              <label class="form-label" for="test_message">Type to Translate</label>
              <textarea class="form-control" name="test_message" id="test_message" rows="10" style="height: 300px;" placeholder="Enter message to translate...">{{ sample_data|default("") }}</textarea>
            </div>
            <button type="submit" class="btn btn-success" id="translate_button">Translate</button>
            <button type="button" class="btn btn-secondary" id="clear_test_message">Clear</button>
          </form>
          <form method="POST" action="/admin/get_last_telegram_post" class="d-inline">
            <button type="submit" class="btn btn-info">Retrieve Last Telegram Post</button>
          </form>
        </div>
        <!-- Output column -->
        <div class="col-md-6 position-relative">
          <label class="form-label">Translated Result</label>
          <div class="border rounded bg-light p-3" id="translation_result" style="height: 300px; overflow-y: auto;">
            {% if translation_result %}
              <p>{{ translation_result|safe }}</p> <!-- Render HTML safely -->
            {% else %}
              <p class="text-muted">Translation result will appear here.</p>
            {% endif %}
          </div>
          <!-- Clear Result Button -->
          <button type="button" class="btn btn-danger position-absolute" style="bottom: 2px; right: 10px;" id="clear_translation_result">Clear Result</button>
        </div>
      </div>
    </div>
    <!-- Spinner -->
    <div id="loading_spinner">
      <div class="alert alert-info d-flex align-items-center" role="alert">
        <div class="spinner-border me-2" role="status" aria-hidden="true"></div>
        <span>Translating... Please wait.</span>
      </div>
    </div>
    <!-- Add footer space -->
    <div style="height: 25px;"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Clear the translation message field on button click
      document.getElementById('clear_test_message').addEventListener('click', function(){
        document.getElementById('test_message').value = '';
      });

      // Clear the translation result field on button click
      document.getElementById('clear_translation_result').addEventListener('click', function(){
        document.getElementById('translation_result').innerHTML = '<p class="text-muted">Translation result will appear here.</p>';
      });

      // Show spinner when the Translate form is submitted
      document.getElementById('translation_form').addEventListener('submit', function(event) {
        event.preventDefault();
        document.getElementById('loading_spinner').style.display = 'block';
        this.submit();
      });

      // Show confirmation modal when Save Template is clicked
      document.getElementById('save_template_btn').addEventListener('click', function(){
        var confirmModal = new bootstrap.Modal(document.getElementById('confirmSaveModal'));
        confirmModal.show();
      });

      // On confirm in modal, perform AJAX call to save the prompt
      document.getElementById('confirm_save_btn').addEventListener('click', function(){
        var confirmEl = document.getElementById('confirmSaveModal');
        var modal = bootstrap.Modal.getInstance(confirmEl);
        modal.hide();
        var formData = new FormData(document.getElementById('save_form'));
        fetch('/admin/save_prompt', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if(data.message) {
            // Show success toast
            var toastEl = document.getElementById('successToast');
            toastEl.style.display = 'block';
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
          } else if(data.error) {
            alert("Error: " + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert("An error occurred while saving the template.");
        });
      });
    </script>
  </body>
</html>
