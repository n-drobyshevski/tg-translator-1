<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Channel Message Translation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
      .toggle-btn {
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <h2>Channel Message Translation</h2>
      <!-- Step 1: Select source channel -->
      <form method="post" class="mb-3">
        <label for="source_channel" class="form-label">Select source channel:</label>
        <select name="source_channel" id="source_channel" class="form-select" required>
          <option value="">-- Select --</option>
          {% for ch in channels %}
            <option value="{{ ch.id }}" {% if selected_channel_id == ch.id %}selected{% endif %}>
              {{ ch.name |e}} ({{ ch.id }}){% if ch.is_en %} [EN]{% endif %}
            </option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary mt-2">Load Messages</button>
      </form>
      <!-- Step 2: Select message -->
      {% if recent_messages %}
        <form method="post" class="mb-3" id="message-form">
          <input type="hidden" name="source_channel" value="{{ selected_channel_id }}">
          <label for="message_id" class="form-label">Select message:</label>
          <select name="message_id" id="message_id" class="form-select" required onchange="updatePreviewContent()">
            {% for msg in recent_messages %}
              <option value="{{ msg.id }}" data-full="{{ msg.html|e }}" {% if selected_message_id == msg.id|string %}selected{% endif %}>
                {{ msg.timestamp }} | {{ msg.html|truncate(80) }}
              </option>
            {% endfor %}
          </select>
          <div class="d-flex gap-2 mt-2">
            {% if not selected_channel_is_en %}
              <button type="submit" name="action" value="translate" class="btn btn-success">Translate</button>
            {% else %}
              <div class="alert alert-warning mb-0 flex-grow-1">Translation is not available for EN channels. You can only delete messages.</div>
            {% endif %}
            <button type="button" class="btn btn-secondary" onclick="togglePreview()">Preview</button>
            <button type="submit" name="action" value="delete" class="btn btn-danger"
              onclick="return confirm('Are you sure you want to delete this message?');">
              Delete Selected Message
            </button>
          </div>
        </form>
        <div id="preview-area" style="display:none;">
          <div class="mt-2">
            <strong>Message Preview:</strong>
            <div id="preview-content" style="white-space: pre-wrap; border:1px solid #ccc; padding:1em; margin-top:0.5em;">
              <!-- Will be filled by JS -->
            </div>
          </div>
        </div>
        <script>
          function togglePreview() {
            var preview = document.getElementById('preview-area');
            if (preview.style.display === 'none' || preview.style.display === '') {
              updatePreviewContent();
              preview.style.display = 'block';
            } else {
              preview.style.display = 'none';
            }
          }
          function updatePreviewContent() {
            var select = document.getElementById('message_id');
            var selected = select.options[select.selectedIndex];
            var content = selected.getAttribute('data-full') || '';
            // Render as HTML
            document.getElementById('preview-content').innerHTML = content;
          }
          // Initialize preview content on page load if preview is visible
          document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('preview-area').style.display !== 'none') {
              updatePreviewContent();
            }
          });
        </script>
      {% endif %}
      <!-- Step 3: Show translation result -->
      {% if translation_result %}
        <div class="row mt-4 mb-2">
          <div class="col-md-6 d-flex flex-column">
            <div class="d-flex align-items-center mb-2">
              <h4 class="mb-0 flex-grow-1">Source Message</h4>
            </div>
            <div id="raw-html-source" style="display: none; white-space: pre-line; border:1px solid #ccc; padding:1em; margin-bottom:1em;">
              <pre style="margin:0; padding:0;">{{ selected_message_text|trim }}</pre>
            </div>
            <div id="source-message-block" class="border rounded bg-light p-3 flex-grow-1 h-100">
              <div>Original Message:</div>
              <div style=" white-space: pre-line; margin-top:-32px">
                <span style="text-align: left;">
                  {{ selected_message_text|trim|safe }}
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-6 d-flex flex-column">
            <div class="d-flex align-items-center mb-2">
              <h4 class="mb-0 flex-grow-1">Translation Result</h4>
              <button type="button"
                      class="btn btn-link text-primary ms-auto"
                      onclick="
                        const srcRaw = document.getElementById('raw-html-source');
                        const srcBlock = document.getElementById('source-message-block');
                        const tgtRaw = document.getElementById('raw-html-content');
                        const tgtBlock = document.getElementById('translated-message-block');
                        const showRaw = (srcRaw.style.display === 'none' || srcRaw.style.display === '') && (tgtRaw.style.display === 'none' || tgtRaw.style.display === '');
                        if (showRaw) {
                          srcRaw.style.display = 'block';
                          srcBlock.style.display = 'none';
                          tgtRaw.style.display = 'block';
                          tgtBlock.style.display = 'none';
                        } else {
                          srcRaw.style.display = 'none';
                          srcBlock.style.display = 'block';
                          tgtRaw.style.display = 'none';
                          tgtBlock.style.display = 'block';
                        }
                      ">
                Toggle Raw HTML
              </button>
            </div>
            <div id="raw-html-content" style="display: none; white-space: pre-wrap; border:1px solid #ccc; padding:1em; margin-bottom:1em;">
              <pre style="margin:0; padding:0;">{{ raw_html_result }}</pre>
            </div>
            <div id="translated-message-block" class="border rounded bg-light p-3 flex-grow-1 h-100">
              <div>Rendered HTML:</div>
              <div style="margin-top:0.5em;">{{ raw_html_result|safe }}</div>
            </div>
          </div>
        </div>
        <div class="clearfix"></div>
        <hr class="my-4">
        <!-- Step 4: Select target channel and post -->
        <form method="post" class="mb-3">
          <input type="hidden" name="source_channel" value="{{ selected_channel_id }}">
          <input type="hidden" name="message_id" value="{{ selected_message_id }}">
          <label for="target_channel" class="form-label">Select target channel:</label>
          <select name="target_channel" id="target_channel" class="form-select" required>
            {% for ch in target_channels %}
              <option value="{{ ch.type }}" {% if selected_target_type == ch.type %}selected{% endif %}>{{ ch.name|e }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-warning mt-2">Post Translation</button>
        </form>
        {% if post_result %}
          <div class="alert alert-info mt-2">{{ post_result }}</div>
        {% endif %}
        {% if delete_result %}
          <div class="alert alert-warning mt-2">{{ delete_result }}</div>
        {% endif %}
      {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>