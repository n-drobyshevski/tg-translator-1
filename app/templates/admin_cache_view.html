{% extends "base.html" %}

{% block title %}Channel Cache Viewer{% endblock %}

{% block head %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- List.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
{% endblock %}

{% block content %}
<div id="cache-table-app" x-data="{ showClearDialog: false, selectedChannel: '' }">
    <div class="flex items-center mb-6">
      {% set href = '/admin' %}
      {% include 'components/back_button.html' %}
      <h1 class="text-3xl font-bold mt-[-5px]">Channel Cache</h1>
      <div class="ml-auto">
        <button @click="showClearDialog = true" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
          <i class="fas fa-trash-alt mr-2"></i>Clear Cache
        </button>
      </div>
    </div>
    <hr class="mb-6">

    <!-- Clear Cache Dialog -->
    <div x-show="showClearDialog" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4"
           @click.away="showClearDialog = false">
        <h3 class="text-lg font-semibold mb-4">Clear Cache</h3>
        <p class="mb-4">Choose which cache to clear:</p>
        <div class="mb-4">
          <label class="block mb-2">
            <input type="radio" x-model="selectedChannel" value="" class="mr-2">
            All Channels
          </label>
          {% for cid, cname in channel_id_to_name.items() %}
          <label class="block mb-2">
            <input type="radio" x-model="selectedChannel" value="{{ cid }}" class="mr-2">
            {{ cname }}
          </label>
          {% endfor %}
        </div>
        <div class="flex justify-end gap-3">
          <button @click="showClearDialog = false" 
                  class="px-4 py-2 border rounded hover:bg-gray-100">
            Cancel
          </button>
          <button @click="clearCache(selectedChannel)" 
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
            Clear Cache
          </button>
        </div>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6 flex flex-wrap gap-4 items-end">
      <div>
        <label for="channel_filter" class="font-medium block text-sm mb-1">Filter by Channel</label>
        <select id="channel_filter" name="channel" class="border rounded px-3 py-2 min-w-[180px]">
          <option value="">All Channels</option>
          {% for cid, cname in channel_id_to_name.items() %}
            <option value="{{ cid }}" {% if request.args.get('channel') == cid %}selected{% endif %}>{{ cname }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex-1">
        <label for="searchQuery" class="font-medium block text-sm mb-1">Search</label>
        <input type="text" id="searchQuery" class="search block w-full border border-gray-300 rounded px-3 py-2" placeholder="Search messages...">
      </div>
    </div>

    {% if error %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">{{ error }}</div>
    {% endif %}

    {% if cache_data %}
      <div class="overflow-x-auto bg-white rounded shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sort" data-sort="channel_name">
                <span class="inline-flex items-center gap-1">
                  Channel
                  <i class="fas fa-sort text-gray-400"></i>
                </span>
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sort" data-sort="message_id">
                <span class="inline-flex items-center gap-1">
                  Message ID
                  <i class="fas fa-sort text-gray-400"></i>
                </span>
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sort" data-sort="date_formatted">
                <span class="inline-flex items-center gap-1">
                  Time
                  <i class="fas fa-sort text-gray-400"></i>
                </span>
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preview</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="cacheTbody" class="list bg-white divide-y divide-gray-200">
            {% set selected_channel = request.args.get('channel') %}
            {% for channel_id, messages in cache_data.items() %}
              {% if not selected_channel or selected_channel == channel_id %}
                {% for msg in messages %}
                  <tr id="source-{{ channel_id }}-{{ msg.message_id }}">
                    <td class="px-4 py-3 channel_name font-semibold text-blue-800">{{ channel_id_to_name.get(channel_id, "Unknown") }}</td>
                    <td class="px-4 py-3 message_id font-mono">{{ msg.message_id }}</td>
                    <td class="px-4 py-3 date_formatted text-xs text-gray-700">{{ msg.date_formatted }}</td>
                    <td class="px-4 py-3">
                      {% if msg.source_channel_id %}
                        {% set source_card = cache_data[msg.source_channel_id|string] if msg.source_channel_id|string in cache_data else None %}
                        {% if source_card %}
                          <button type="button"
                            class="text-blue-600 hover:underline bg-transparent px-0 py-0 border-none transition-colors duration-200 go-to-source-link"
                            data-target="source-{{ msg.source_channel_id }}-{{ msg.source_message_id }}">
                            from : {{ msg.source_channel_id }} | {{ msg.source_message_id }}
                          </button>
                        {% else %}
                          from : {{ msg.source_channel_id }} | {{ msg.source_message_id }}
                        {% endif %}
                      {% else %}
                        &mdash;
                      {% endif %}
                    </td>
                    <td class="px-4 py-3">
                      <div class="max-w-md text-sm text-gray-600 whitespace-pre-wrap">{{ msg.text[:200] }}{% if msg.text|length > 200 %}...{% endif %}</div>
                    </td>
                    <td class="px-4 py-3 text-right">
                      <button onclick="deleteMessage('{{ channel_id }}', '{{ msg.message_id }}')"
                              class="text-red-600 hover:text-red-800 transition-colors">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="bg-gray-50 p-8 rounded shadow text-center">
        <p class="text-gray-600">No cached messages found.</p>
      </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize List.js
  const options = {
    valueNames: ['channel_name', 'message_id', 'date_formatted']
  };
  const cacheList = new List('cache-table-app', options);

  // Channel filter
  const channelFilter = document.getElementById('channel_filter');
  channelFilter.addEventListener('change', function(e) {
    const channel = e.target.value;
    window.location.href = channel ? `/admin/cache?channel=${channel}` : '/admin/cache';
  });

  // Source link navigation
  document.querySelectorAll('.go-to-source-link').forEach(link => {
    link.addEventListener('click', function() {
      const targetId = this.dataset.target;
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth' });
        targetElement.classList.add('bg-yellow-100');
        setTimeout(() => targetElement.classList.remove('bg-yellow-100'), 2000);
      }
    });
  });
});

// Cache management functions
function clearCache(channelId) {
  const formData = new FormData();
  if (channelId) {
    formData.append('channel_id', channelId);
  }

  fetch('/admin/cache/clear', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Error clearing cache: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to clear cache');
  });
}

function deleteMessage(channelId, messageId) {
  if (!confirm('Are you sure you want to delete this message?')) {
    return;
  }

  fetch(`/admin/cache/delete/${messageId}?channel_id=${channelId}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const row = document.getElementById(`source-${channelId}-${messageId}`);
      if (row) {
        row.remove();
      }
    } else {
      alert('Error deleting message: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to delete message');
  });
}
</script>
{% endblock %}
