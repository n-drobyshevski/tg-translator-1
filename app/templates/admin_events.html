{% extends 'base.html' %}
{% from 'components/modal.html' import modal %}

{% block title %}Admin Events{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/column_chooser.css') }}">
    <style>
      html, body { font-family: "Roboto", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                    "Segoe UI", Arial, sans-serif; }

      .enterprise-table thead th {
        background: #f6f7fa;
        position: sticky;
        top: 0;
        z-index: 2;
        font-weight: 500;
        color: #22304a;
        border-bottom: 2px solid #e3e8ee;
        border-right: 1px solid #e3e8ee;
        user-select: none;
        cursor: pointer;
        transition: background 0.15s;
      }
      
      /* Column-specific styles */
      .col-timestamp {
        max-width: 120px !important;
        min-width: 100px !important;
      }
      
      .col-event {
        max-width: 120px !important;
      }

      .col-source_channel, .col-dest_channel {
        max-width: 100px !important;
        min-width: 80px !important;
      }
      
      .col-source_channel_name, .col-dest_channel_name {
        max-width: 180px !important;
        min-width: 150px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .col-message_id {
        max-width: 80px !important;
        min-width: 60px !important;
        text-align: right;
      }

      .col-retry_count {
        max-width: 60px !important;
        min-width: 40px !important;
        text-align: right;
      }

      .col-posting_success {
        max-width: 70px !important;
        min-width: 70px !important;
        text-align: center;
      }      .col-source_content {
        min-width: 180px !important;
        max-width: 350px !important;
        background-color: #f9fcff; /* Very light blue background */
        font-family: 'Roboto Mono', monospace;
        font-size: 13px;
        color: #444;
      }
      
      .col-preview {
        min-width: 200px !important;
        max-width: 400px !important;
      }
      
      /* Tooltip styles */
      .col-header {
        position: relative;
      }
      
      .enterprise-table td, .enterprise-table th {
        padding: 8px 12px;
        font-size: 14px;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px; /* Default max width */
      }
      
      .enterprise-table th.sorted { background: #e9edf5; }
      .enterprise-table th:last-child,
      .enterprise-table td:last-child { border-right: none; }
      .enterprise-table tr { border-bottom: 1px solid #e3e8ee; }
      .enterprise-table tbody tr:nth-child(odd) { background: #f9fafb; }
      .enterprise-table tbody tr:hover { background: #e9edf5; transition: background 0.15s; }
      .enterprise-table td, .enterprise-table th {
        padding: 12px 18px;
        font-size: 15px;
        vertical-align: middle;
        white-space: nowrap;
      }
      .drag-handle { cursor: grab; color: #babfc6; margin-right: 6px; }
      .column-chooser-modal {
        min-width: 320px;
        border-radius: 12px;
        box-shadow: 0 4px 32px rgba(24,39,75,0.14);
      }
      .column-chooser-list { max-height: 330px; overflow-y: auto; }
      .column-chooser-li {
        background: #f6f7fa;
        border-radius: 6px;
        margin-bottom: 7px;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.13s;
        gap: 12px;
      }
      .column-chooser-li:hover { background: #eef1f7; }
      .preview-lineclamp {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal;
        word-break: break-word;
        max-width: 600px;
        min-width: 280px;
        max-height: 3.4em;
        font-family: "Roboto", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                      "Segoe UI", Arial, sans-serif;
        font-size: 0.8em;
        color: #334155;
        cursor: pointer;
        background: transparent;
        border: none;
        padding: 0;
        transition: background 0.2s;
      }
      .preview-lineclamp:hover { background: #e0e7ef; }
      .sort-arrow {
        font-size: 0.95em;
        margin-left: 5px;
        vertical-align: middle;
        color: #7c8799;
      }
      .filter-bar-row {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .filter-bar-row:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .filter-field,
      .filter-operator {
        min-width: 140px;
        height: 40px;
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: #1e293b;
        background-color: white;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.25rem;
        appearance: none;
        transition: all 0.2s ease-in-out;
      }

      .filter-value {
        flex-grow: 1;
        height: 40px;
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: #1e293b;
        background-color: white;
        transition: all 0.2s ease-in-out;
      }

      .filter-field:hover,
      .filter-operator:hover,
      .filter-value:hover {
        border-color: #cbd5e1;
      }

      .filter-field:focus,
      .filter-operator:focus,
      .filter-value:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .filter-remove-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 0.5rem;
        color: #ef4444;
        background: transparent;
        transition: all 0.2s ease-in-out;
      }

      .filter-remove-btn:hover {
        background-color: #fef2f2;
        color: #dc2626;
      }

      .filter-remove-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
      }

      #filtersContainer {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
        width: 100%;
      }

      #addFilterBtn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        height: 40px;
        padding: 0 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #1e293b;
        background-color: #f1f5f9;
        transition: all 0.2s ease-in-out;
      }

      #addFilterBtn:hover {
        background-color: #e2e8f0;
      }

      #addFilterBtn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }

      #addFilterBtn i {
        font-size: 0.875rem;
      }

      @media (max-width: 768px) {
        .filter-bar-row {
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
          padding: 0.75rem;
        }

        .filter-field,
        .filter-operator {
          width: 100%;
          min-width: unset;
        }

        .filter-remove-btn {
          align-self: flex-end;
          margin-top: 0.25rem;
        }
      }
      /* Styles for the details modal content */
      .message-fallback {
        color: #777;
        font-style: italic;
      }
      .message-text {
        white-space: pre-wrap; /* Allow wrapping */
        word-break: break-word; /* Break long words */
        font-family: 'Roboto Mono', monospace; /* Monospaced font for code/text */
        font-size: 13px;
        background-color: #fff;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .message-media {
        font-size: 12px;
        color: #555;
        margin-top: 5px;
      }
      .success-badge {
        background-color: #d1fae5; /* Light green */
        color: #065f46; /* Dark green */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .error-badge {
        background-color: #fee2e2; /* Light red */
        color: #991b1b; /* Dark red */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .info-badge {
        background-color: #e0e7ff; /* Light indigo */
        color: #3730a3; /* Dark indigo */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .error-details {
        font-size: 12px;
        color: #b91c1c; /* Slightly lighter red for details */
        margin-top: 4px;
        display: block;
      }

      /* Enhanced Modal Styles */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        will-change: opacity;
        padding: 1.5rem;
      }

      .modal-overlay:not(.hidden) {
        opacity: 1;
      }

      .modal-container {
        max-width: min(95vw, 1200px);
        width: 100%;
        max-height: 90vh;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: scale(0.95) translateY(-10px);
        opacity: 0;
        transition: all 0.2s ease-out;
        display: flex;
        flex-direction: column;
        margin: auto;
        position: relative;
      }

      .modal-overlay:not(.hidden) .modal-container {
        transform: scale(1) translateY(0);
        opacity: 1;
      }

      .modal-header {
        padding: 1.25rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #0f172a;
        line-height: 1.4;
      }

      .modal-close-btn {
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        color: #64748b;
        transition: all 0.15s ease;
        cursor: pointer;
        border: none;
        background: transparent;
      }

      .modal-close-btn:hover {
        background: #f1f5f9;
        color: #0f172a;
      }

      .modal-body {
        padding: 1.5rem;
        background: #fff;
        color: #333;
        font-size: 14px;
        line-height: 1.6;
        overflow-y: auto;
        max-height: calc(90vh - 4rem);
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }

      .preview-area {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 1rem;
        min-height: 100px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        line-height: 1.25;
      }

      .status-success {
        background-color: #ecfdf5;
        color: #059669;
      }

      .status-error {
        background-color: #fef2f2;
        color: #dc2626;
      }

      .status-warning {
        background-color: #fffbeb;
        color: #d97706;
      }

      .status-info {
        background-color: #eff6ff;
        color: #3b82f6;
      }

      .message-cards-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .status-cards-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
      }

      .message-card, .status-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1.25rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4b5563;
        margin-bottom: 0.5rem;
      }

      .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        line-height: 1.25;
        color: #1f2937;
        background: #fff;
        transition: border-color 0.15s ease-in-out;
      }

      .form-control[readonly] {
        background-color: #f8fafc;
        cursor: not-allowed;
      }

      .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .section-title i {
        font-size: 0.875rem;
        color: #6366f1;
      }

      @media (max-width: 768px) {
        .message-cards-container,
        .status-cards-container {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .modal-container {
          margin: 0.5rem;
          max-height: calc(100vh - 1rem);
        }
      }

      /* Column customization styles */
      .column-chooser-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 1rem;
      }

      .column-item {
        cursor: move;
      }

      .column-item.dragging {
        opacity: 0.5;
      }

      /* Toggle switch styles */
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
      }

      input:checked + .slider {
        background-color: #2196F3;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .slider.round {
        border-radius: 24px;
      }

      .slider.round:before {
        border-radius: 50%;
      }
    </style>
{% endblock %}

{% block header %}
<div class="flex items-center w-full">
  
  <div class="flex flex-row w-full items-center justify-between">
        
  <h1 class="page-title">
    <span>Admin Events</span>
  </h1>
  </div>
</div>

{% endblock %}

{% block content %}
{# First import the modal body #}
{% from 'events_edit_modal.html' import body as modal_body with context %}

<!-- Column Chooser Modal -->
<div id="column-chooser-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="column-chooser-title">
    <div class="modal-container bg-white rounded-lg shadow-xl max-w-2xl">
        <div class="modal-header bg-gray-50 border-b border-gray-200 px-6 py-4">
            <h3 id="column-chooser-title" class="modal-title text-xl font-semibold text-gray-800">Customize Columns</h3>
            <button type="button" class="modal-close-btn text-gray-500 hover:text-gray-700 transition-colors" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body p-6">
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <p class="text-sm text-gray-600">Drag and drop columns to reorder them. Toggle visibility using the switches.</p>
                    <button type="button" id="reset-columns" class="text-sm text-blue-600 hover:text-blue-800 transition-colors">
                        Reset to Default
                    </button>
                </div>
                <div class="relative">
                    <input type="text" id="column-search" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg pl-10 text-sm"
                           placeholder="Search columns..."
                           aria-label="Search columns">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="columns-container max-h-[400px] overflow-y-auto">
                <ul id="column-list" class="column-chooser-list space-y-2" role="list" aria-label="Draggable column list">
                    <!-- Column items will be dynamically inserted here -->
                </ul>
            </div>
        </div>
        <div class="modal-footer bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end space-x-3">
            <button type="button" id="cancel-columns" class="btn-secondary">
                Cancel
            </button>
            <button type="button" id="apply-columns" class="btn-primary">
                Apply Changes
            </button>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal-container bg-white rounded-lg shadow-xl">
        <div class="flex items-center justify-between p-4 border-b">
            <h3 class="text-xl font-semibold text-gray-900">Message Preview</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeModal('preview-modal')">
                <span class="sr-only">Close</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4 max-h-[70vh] overflow-y-auto">
            <div id="preview-content"></div>
        </div>
    </div>
</div>
<!-- Table Controls -->
<div class="mb-6">
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <button id="openColumnChooser" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
      <i class="fas fa-columns"></i>
      <span>Customize Columns</span>
    </button>
    <button id="addFilterBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
      <i class="fas fa-filter"></i>
      <span>Add Filter</span>
      <span class="filter-count hidden ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"></span>
    </button>
  </div>
  <div id="filtersContainer" class="w-full" role="region" aria-label="Active filters"></div>
</div>
<!-- Events Table -->
<div class="overflow-x-auto">
    <table id="eventsTable" class="enterprise-table w-full">
        <thead>
          <tr>
            <th data-column="timestamp" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
            <th data-column="event" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
            <th data-column="source_channel_name" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source Channel</th>
            <th data-column="dest_channel_name" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination</th>
            <th data-column="message_id" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Msg ID</th>
            <th data-column="posting_success" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th data-column="preview" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preview</th>
            <th data-column="actions" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="eventsTbody"></tbody>
    </table>
</div>



{# Edit and Details Modals #}
{{ modal('edit-modal', 'Edit Event', modal_body) }}
{{ modal('details-modal', 'Event Details', modal_body) }}

{% endblock %}


{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{{ url_for('static', filename='js/utils/sanitize.js') }}"></script>
  <script src="{{ url_for('static', filename='events_edit_modal.js') }}"></script>

  {# Data island for channel_cache JSON #}
  <script id="channelCacheJsonData" type="application/json">
    {{- channel_cache | tojson | safe -}}
  </script>

  <script>
    console.log('Admin Events page script started.');

    // This will be the globally accessible parsed cache data for this page
    let channelCacheData = {};

    try {
        const channelCacheJsonElement = document.getElementById('channelCacheJsonData');
        // Ensure element exists and textContent is not null before accessing
        const channelCacheJsonString = channelCacheJsonElement ? channelCacheJsonElement.textContent : null;

        if (channelCacheJsonString && channelCacheJsonString.trim() !== "") {
            channelCacheData = JSON.parse(channelCacheJsonString);
            // console.log("Successfully parsed channel_cache from data island:", channelCacheData); // For debugging
        } else {
            console.warn("channel_cache JSON string from data island is empty, not found, or whitespace.");
        }
    } catch (error) {
        console.error("Error parsing channel_cache JSON from data island:", error);
        const rawContent = document.getElementById('channelCacheJsonData') ? document.getElementById('channelCacheJsonData').textContent : "Element not found";
        // console.error("Raw content from data island was:", rawContent); // Be cautious with logging potentially large/sensitive data
        // channelCacheData remains {}
    }

    // Initialize cache for events_edit_modal.js if its initCache function is available
    // This replaces the previous block: var rawJsonData = ...; try { var parsedCacheData = JSON.parse(rawJsonData); initCache(parsedCacheData); ... }
    if (typeof initCache === "function") {
        initCache(channelCacheData || {}); // Pass the parsed data
    } else {
        // console.warn("initCache function (from events_edit_modal.js) not found at initial parse time."); // Optional warning
    }

/*==========================================================================================
  → GLOBAL VARIABLES & UTILITY FUNCTIONS
==========================================================================================*/
const FIELDS_KEY = "admin_stats_visible_fields_v2";
const ORDER_KEY = "admin_stats_column_order_v2";

let allFields = [], eventsData = []; 
// The 'let channelCacheData = {};' declaration and subsequent try-catch block that previously re-parsed
// '{{ channel_cache | tojson | safe }}' is removed, as 'channelCacheData' is now populated above.
// channelCacheData is already defined and populated from the data island.

let displayedEvents = []; // ← holds the current filtered+sorted list

let activeFilters = [];
let sortState = { column: "timestamp", dir: -1 };

const FILTER_OPERATORS = ["IS", "IS NOT", "EXISTS", "DOES NOT EXIST"];
let FILTER_FIELDS = [
  "timestamp", "event", "edit_timestamp", "source_channel", "source_channel_name",
  "dest_channel", "dest_channel_name", "message_id", "media_type", "file_size_bytes",
  "original_size", "translated_size", "translation_time", "retry_count",
  "posting_success", "api_error_code", "exception_message", "preview", "source_content",
  "actions"
];

function prettifyFieldName(field) {  // Short display names
  const displayNames = {
    "timestamp": "Time",
    "event": "Event",
    "edit_timestamp": "Edit Time",
    "source_channel": "Source ID",
    "source_channel_name": "Source Channel",
    "dest_channel": "Dest ID",
    "dest_channel_name": "Destination",
    "message_id": "Msg ID",
    "media_type": "Media",
    "file_size_bytes": "File Size",
    "original_size": "Orig Size",
    "translated_size": "Trans Size",
    "translation_time": "Trans Time",
    "retry_count": "Retries",
    "posting_success": "Status",
    "api_error_code": "Error Code",
    "exception_message": "Error",
    "preview": "Preview",
    "source_content": "Source",
    "actions": "Actions"
  };

  // Full names for tooltips
  const tooltips = {
    "timestamp": "When the event occurred",
    "event": "Type of event",
    "edit_timestamp": "When the event was last edited",
    "source_channel": "Source channel ID",
    "source_channel_name": "Source channel name",
    "dest_channel": "Destination channel ID",
    "dest_channel_name": "Destination channel name",
    "message_id": "Message ID",
    "media_type": "Type of media attached",
    "file_size_bytes": "Size of attached file in bytes",
    "original_size": "Original message size",
    "translated_size": "Translated message size",
    "translation_time": "Time taken to translate",
    "retry_count": "Number of retry attempts",
    "posting_success": "Whether posting succeeded",
    "api_error_code": "API error code if any",
    "exception_message": "Exception message if any",
    "preview": "Preview of translated message",
    "source_content": "Original message content",
    "actions": "Edit or view details"
  };

  const name = displayNames[field] || field;

  return {
    short: name,  // Short name for table header
    tooltip: tooltips[field] || name // Fallback tooltip to the formatted name
  };
}

function getVisibleFields() {
  const stored = localStorage.getItem(FIELDS_KEY);
  if (stored) return JSON.parse(stored);
  // Default minimal set of visible fields
  return [
    "timestamp",
    "event",
    // "source_channel", // ID might be too much for default view
    "source_channel_name",
    // "dest_channel",   // ID might be too much for default view
    "dest_channel_name",
    "message_id",
    "posting_success",
    "preview",        // Translated message from event
    "actions"         // Always include actions column
  ];
}

function setVisibleFields(arr) { 
  // Ensure actions column is always included
  if (!arr.includes("actions")) {
    arr.push("actions");
  }
  localStorage.setItem(FIELDS_KEY, JSON.stringify(arr)); 
}

function getColumnOrder() {
  const stored = localStorage.getItem(ORDER_KEY);
  // Ensure allFields is populated before filtering, or filter against a known full list initially
  const defaultOrder = allFields.length > 0 ? allFields.slice() : FILTER_FIELDS.slice();
  if (stored) {
      const parsedOrder = JSON.parse(stored);
      // Filter out any fields that might no longer exist
      return parsedOrder.filter(f => defaultOrder.includes(f));
  }
  return defaultOrder;
}
function setColumnOrder(arr) { localStorage.setItem(ORDER_KEY, JSON.stringify(arr)); }

function updateModal(id, title, body, footer) {
  const titleEl = document.getElementById(id + "-title");
  if (titleEl) titleEl.textContent = title;
  
  const bodyEl = document.querySelector("#" + id + " .modal-body");
  if (bodyEl) bodyEl.innerHTML = body;
  
  const footerEl = document.querySelector("#" + id + " .modal-footer");
  if (footerEl && footer !== undefined) footerEl.innerHTML = footer;
}

function showPreviewModal(htmlContent) { // Renamed param for clarity
  updateModal("preview-modal", "Full Message Preview",
    `<div class="bg-slate-50 border border-slate-200 rounded-lg p-3 font-roboto text-base text-gray-800" style="white-space:pre-wrap; word-break:break-word;">${htmlContent}</div>`,
    `<button onclick="closeModal('preview-modal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>`);
  openModal("preview-modal");
}

function renderColumnChooserHtml() {
  const order = getColumnOrder();
  const visibleFields = getVisibleFields();
  let html = `<div class="column-chooser-list">`;
  order.forEach(field => {
    const isVisible = visibleFields.includes(field);
    const fieldNameParts = prettifyFieldName(field); // Returns {short: ..., tooltip: ...}
    const displayName = fieldNameParts.short;
    const tooltipText = fieldNameParts.tooltip || '';
    // Use string concatenation for HTML generation to avoid issues with backticks in Jinja context
    html += 
      '<div class="column-chooser-li" data-field="' + field + '" title="' + tooltipText + '">' +
        '<div class="flex items-center gap-2">' +
          '<i class="fas fa-grip-vertical drag-handle"></i>' +
          '<label class="flex items-center gap-2 cursor-pointer">' +
            '<input type="checkbox" data-field="' + field + '" ' + (isVisible ? 'checked' : '') + ' class="form-checkbox h-4 w-4 text-blue-600">' +
            '<span class="select-none">' + displayName + '</span>' +
          '</label>' +
        '</div>' +
      '</div>';
  });
  html += '</div>';
  return html;
}

function showColumnChooser() {
  let chooserHtml = renderColumnChooserHtml();
  // Use string concatenation for HTML generation
  updateModal("column-chooser-modal", "Customize Columns", 
    '<div class="mb-3 text-sm text-gray-600">' +
      'Drag to reorder. Check to show. Default view shows essential fields.' +
     '</div>' +
     '<div id="columnChooserListContainer">' + chooserHtml + '</div>', 
    '<button onclick="applyColumnChangesAndClose()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Apply</button>' +
     '<button onclick="closeModal(&#39;column-chooser-modal&#39;)" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 ml-2">Cancel</button>');
  
  openModal("column-chooser-modal");
  
  const listContainer = document.getElementById("columnChooserListContainer");
  const actualList = listContainer.querySelector(".column-chooser-list"); // Get the actual list element

  listContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener("change", function() {
      // Changes are applied on "Apply" button click now, direct application removed from here
    });
  });

  Sortable.create(actualList, { // Target the actual list for Sortable
    handle: ".drag-handle",
    animation: 180,
    onEnd: function(evt) {
      // Order is also applied on "Apply" button click
    }
  });
}

function applyColumnChangesAndClose() {
    const listContainer = document.getElementById("columnChooserListContainer");
    const checkboxes = listContainer.querySelectorAll('input[type="checkbox"]');
    let newVisibleFields = [];
    checkboxes.forEach(cb => {
        if (cb.checked) {
            newVisibleFields.push(cb.getAttribute("data-field"));
        }
    });
    setVisibleFields(newVisibleFields);

    const orderedElements = listContainer.querySelectorAll(".column-chooser-li");
    const newOrder = Array.from(orderedElements).map(el => el.getAttribute("data-field"));
    setColumnOrder(newOrder);
    
    renderTable(); 
    updateTableColumnVisibility(); 
    closeModal('column-chooser-modal');
}


function compareValues(a, b, field) {
  if (field === "timestamp" || field === "edit_timestamp") {
    const dateA = a ? new Date(a) : new Date(0); 
    const dateB = b ? new Date(b) : new Date(0);
    return dateA - dateB;
  }
  if (field === "posting_success") {
    const valA = a === true ? 1 : (a === false ? 0 : -1); 
    const valB = b === true ? 1 : (b === false ? 0 : -1);
    return valA - valB;
  }

  const numA = parseFloat(a);
  const numB = parseFloat(b);

  if (!isNaN(numA) && !isNaN(numB) && String(a).match(/^\d+(\.\d+)?$/) && String(b).match(/^\d+(\.\d+)?$/) ) {
    return numA - numB;
  }
  
  return (String(a ?? "")).toLowerCase().localeCompare(String(b ?? "").toLowerCase());
}

function filterData(rawData) {
  return rawData.filter(event => {
    return activeFilters.every(filter => {
      const { field, operator, value } = filter;
      let eventValue = event[field];
      
      if (field === "source_content") {
          const sourceMsg = event.source_channel && event.message_id ? 
                            findCachedMessage(String(event.source_channel), String(event.message_id)) : null;
          eventValue = sourceMsg ? (sourceMsg.text || sourceMsg.caption || "") : "";
      }

      if (typeof eventValue === 'boolean') {
        eventValue = String(eventValue); 
      }
      eventValue = eventValue ?? "";


      const filterValues = value.split(",").map(v => v.trim().toLowerCase());
      const lowerEventValue = String(eventValue).toLowerCase();

      switch (operator) {
        case "IS":
          return filterValues.includes(lowerEventValue);
        case "IS NOT":
          return !filterValues.includes(lowerEventValue);
        case "EXISTS": 
          return lowerEventValue !== "";
        case "DOES NOT EXIST": 
          return lowerEventValue === "";
        default: return true;
      }
    });
  });
}

function renderTable() {
  const order = getColumnOrder();
  const visibleFields = getVisibleFields();
  
  let table = document.getElementById("eventsTable");
  if (!table) { console.error("Table element #eventsTable not found!"); return; }

  let head = table.querySelector("thead");
  if (!head) {
      head = document.createElement("thead");
      table.appendChild(head);
  }
  head.innerHTML = '<tr id="eventsTableHeadRow"></tr>'; 
  const headRow = head.querySelector("#eventsTableHeadRow");

  order.forEach(field => {
    if (!visibleFields.includes(field)) return;
    const fieldNameParts = prettifyFieldName(field);
    const th = document.createElement("th");
    // Use string concatenation for className and innerHTML
    th.className = 'col-header col-' + field;
    th.dataset.field = field;
    th.title = fieldNameParts.tooltip || fieldNameParts.short;
    th.innerHTML = fieldNameParts.short + ' <span class="sort-arrow"></span>';
    th.addEventListener("click", () => {
      if (sortState.column === field) {
        sortState.dir *= -1;
      } else {
        sortState.column = field;
        sortState.dir = 1;
      }
      displayedEvents.sort((a, b) => compareValues(a[field], b[field], field) * sortState.dir);
      if (field === "source_content") {
          displayedEvents.sort((a, b) => {
              const msgA = a.source_channel && a.message_id ? findCachedMessage(String(a.source_channel), String(a.message_id)) : null;
              const valA = msgA ? (msgA.text || msgA.caption || "") : "";
              const msgB = b.source_channel && b.message_id ? findCachedMessage(String(b.source_channel), String(b.message_id)) : null;
              const valB = msgB ? (msgB.text || msgB.caption || "") : "";
              return compareValues(valA, valB, field) * sortState.dir;
          });
      }
      renderTableBody(displayedEvents);
      updateSortArrows();
    });
    headRow.appendChild(th);
  });
  updateSortArrows(); 

  displayedEvents = filterData(eventsData);
  if (sortState.column === "timestamp" && eventsData.length > 0) {
    displayedEvents.sort((a, b) => compareValues(a.timestamp, b.timestamp, "timestamp") * sortState.dir);
  }
  renderTableBody(displayedEvents);
}

function updateSortArrows() {
  document.querySelectorAll("#eventsTableHeadRow th").forEach(th => {
    const arrow = th.querySelector(".sort-arrow");
    if (!arrow) return;
    if (th.dataset.field === sortState.column) {
      arrow.innerHTML = sortState.dir === 1 ? "▲" : "▼";
    } else {
      arrow.innerHTML = "";
    }
  });
}

function renderActions(event) {
    return `
        <div class="flex items-center space-x-2">
            <button onclick="showEditOrDetails(event, '${event.id}', true)" 
                    class="px-2 py-1 text-sm text-blue-600 hover:text-blue-800">
                <i class="fas fa-edit"></i>
            </button>
            <button onclick="showEditOrDetails(event, '${event.id}', false)"
                    class="px-2 py-1 text-sm text-gray-600 hover:text-gray-800">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    `;
}

function formatTimestamp(timestamp) {
  if (!timestamp) return '-';
  const date = new Date(timestamp);
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${hours}:${minutes} ${day}-${month}-${year}`;
}

function renderTableBody(data) {
  const tbody = document.getElementById("eventsTbody");
  if (!tbody) { console.error("Tbody element #eventsTbody not found!"); return; }
  tbody.innerHTML = ""; 

  const visibleFields = getVisibleFields();
  const order = getColumnOrder();

  data.forEach(event => {
    const row = tbody.insertRow();
    row.className = "event-row"; 
    row.addEventListener('click', (e) => {
        if (e.target.closest('button, a, input, .preview-lineclamp')) {
            return;
        }
        showDetailsModal(event); 
    });

    // Add cells for all visible fields
    order.forEach(field => {
      if (!visibleFields.includes(field)) return;
      const cell = row.insertCell();
      cell.className = "col-" + field;

      let cellValue = event[field];
      // Format timestamps in HH:MM DD-MM-YYYY format
      if (field === "timestamp" || field === "edit_timestamp") {
        cellValue = formatTimestamp(cellValue);
      } else if (field === "posting_success") {
        cellValue = cellValue ? '<span class="success-badge">OK</span>' : '<span class="error-badge">FAIL</span>';
      } else if (field === "preview" && typeof cellValue === "string") {
        cellValue = `<button class="preview-lineclamp" onclick="event.stopPropagation(); showPreviewModal(\`${cellValue.replace(/`/g, '\\`')}\`)">${cellValue}</button>`;
      } else if (field === "actions") {
        cellValue = renderActions(event);
      }
      cell.innerHTML = cellValue ?? "";
      
      if (cell.className.includes("col-message_id") || cell.className.includes("col-retry_count")) {
        cell.style.textAlign = "right";
      }
    });

    // Add action buttons cell
    const actionCell = row.insertCell();
    actionCell.className = "text-right whitespace-nowrap px-4";
    actionCell.style.width = "120px";
    actionCell.innerHTML = `
      <button 
        onclick="event.stopPropagation(); showEditModal(${JSON.stringify(event).replace(/"/g, '&quot;')})" 
        class="text-blue-600 hover:text-blue-800 font-medium text-sm px-2 py-1 rounded hover:bg-blue-50"
        title="Edit event">
        <i class="fas fa-edit"></i>
      </button>
      <button 
        onclick="event.stopPropagation(); showDetailsModal(${JSON.stringify(event).replace(/"/g, '&quot;')})"
        class="text-gray-600 hover:text-gray-800 font-medium text-sm px-2 py-1 rounded hover:bg-gray-50"
        title="View details">
        <i class="fas fa-info-circle"></i>
      </button>
    `;
  });
}


function updateTableColumnVisibility() {
  renderTable(); 
}

//==========================================================================================
//  → FILTERS
//==========================================================================================
function addFilter() {
  const filterId = 'filter-' + Date.now();
  const filterHtml = `
    <div id="${filterId}" class="filter-bar-row" style="opacity: 0; transform: translateX(-10px);" role="group" aria-label="Filter criteria">
      <select class="filter-field" aria-label="Filter field">
        ${FILTER_FIELDS.map(f => {
          const fieldName = prettifyFieldName(f);
          return `<option value="${f}" title="${fieldName.tooltip}">${fieldName.short}</option>`;
        }).join('')}
      </select>
      <select class="filter-operator" aria-label="Filter operator">
        ${FILTER_OPERATORS.map(op => `<option value="${op}">${op}</option>`).join('')}
      </select>
      <input type="text" class="filter-value" 
        placeholder="Value (comma-separated for IS/IS NOT)" 
        aria-label="Filter value"
        autocomplete="off">
      <button type="button"
        class="filter-remove-btn" 
        onclick="removeFilter('${filterId}')"
        aria-label="Remove filter">
        <i class="fas fa-times" aria-hidden="true"></i>
      </button>
    </div>`;
  document.getElementById("filtersContainer").insertAdjacentHTML("beforeend", filterHtml);
  
  // Animate the new filter row
  setTimeout(() => {
    const filterElement = document.getElementById(filterId);
    filterElement.style.opacity = "1";
    filterElement.style.transform = "translateX(0)";
  }, 10);
  
  const newFilterElement = document.getElementById(filterId);
  const inputs = newFilterElement.querySelectorAll("select");
  const valueInput = newFilterElement.querySelector(".filter-value");
  
  // Handle immediate changes from dropdowns
  inputs.forEach(input => input.addEventListener("change", applyFiltersAndRender));
  
  // Debounce text input
  const debouncedFilterUpdate = debounce(applyFiltersAndRender, 300);
  valueInput.addEventListener("input", debouncedFilterUpdate);
  
  // Add keyboard interaction
  valueInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      valueInput.blur();
      applyFiltersAndRender();
    } else if (e.key === "Escape") {
      e.preventDefault();
      valueInput.value = "";
      applyFiltersAndRender();
    }
  });

  // Update ARIA labels when field changes
  const fieldSelect = newFilterElement.querySelector(".filter-field");
  fieldSelect.addEventListener("change", () => {
    const fieldName = prettifyFieldName(fieldSelect.value);
    valueInput.setAttribute("aria-label", `Filter value for ${fieldName.short}`);
    valueInput.setAttribute("placeholder", `Enter ${fieldName.short.toLowerCase()} value...`);
  });


  activeFilters.push({ 
    id: filterId, 
    field: newFilterElement.querySelector(".filter-field").value, 
    operator: newFilterElement.querySelector(".filter-operator").value, 
    value: "" 
  });
  applyFiltersAndRender();
}

function removeFilter(filterId) {
  const filterElement = document.getElementById(filterId);
  if (filterElement) {
    filterElement.style.opacity = "0";
    filterElement.style.transform = "translateX(10px)";
    setTimeout(() => {
      filterElement.remove();
      activeFilters = activeFilters.filter(f => f.id !== filterId);
      applyFiltersAndRender();
      updateFilterCount();
    }, 200);
  }
}

function updateFilterCount() {
  const countElement = document.querySelector("#addFilterBtn .filter-count");
  if (countElement) {
    const count = activeFilters.length;
    countElement.textContent = count;
    countElement.classList.toggle("hidden", count === 0);
  }
}

// Debounce helper
const debounce = (fn, ms) => {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), ms);
  };
};

function applyFiltersAndRender() {
  activeFilters = Array.from(document.querySelectorAll("#filtersContainer > div")).map(filterElement => ({
    id: filterElement.id,
    field: filterElement.querySelector(".filter-field").value,
    operator: filterElement.querySelector(".filter-operator").value,
    value: filterElement.querySelector(".filter-value").value.trim()
  }));
  
  displayedEvents = filterData(eventsData);
  updateFilterCount();
  if (sortState.column) {
    displayedEvents.sort((a, b) => {
        let valA = a[sortState.column];
        let valB = b[sortState.column];
        if (sortState.column === "source_content") {
            const msgA = a.source_channel && a.message_id ? findCachedMessage(String(a.source_channel), String(a.message_id)) : null;
            valA = msgA ? (msgA.text || msgA.caption || "") : "";
            const msgB = b.source_channel && b.message_id ? findCachedMessage(String(b.source_channel), String(b.message_id)) : null;
            valB = msgB ? (msgB.text || msgB.caption || "") : "";
        }
        return compareValues(valA, valB, sortState.column) * sortState.dir;
    });
  }
  renderTableBody(displayedEvents);
}


//==========================================================================================
//  → INITIALIZATION
//==========================================================================================
document.addEventListener("DOMContentLoaded", () => {
  // console.log("Admin Events page script started."); // This console log is now at the top of the script
  // Initialize cacheData for the modal script
  // Ensure channelCacheData is populated before this line, or handle potential undefined state in events_edit_modal.js
  if (typeof initializeCache === "function") {
    initializeCache(channelCacheData || {}); // Uses the channelCacheData parsed from the data island
  } else {
    console.warn("initializeCache function not found. Ensure events_edit_modal.js is loaded and defines it.");
  }

  fetch("{{ url_for('admin_stats_bp.admin_stats_detail') }}")
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        console.error("Error from server:", data.error);
        alert("Error fetching events: " + data.error);
        return;
      }
      // Add IDs to events data
      eventsData = processEventsData(data.events_last_100 || []);
      
      if (eventsData.length > 0) {
        allFields = Object.keys(eventsData[0] || {});
      } else {
        // If eventsData is empty, use FILTER_FIELDS as a fallback for allFields
        // This ensures the column chooser can still be populated even with no data
        allFields = FILTER_FIELDS.slice(); 
        console.warn("No events data received, using default fields for column chooser.");
      }
      
      // Initialize or update column order based on potentially new allFields
      let currentOrder = getColumnOrder();
      // Add any new fields from allFields to the currentOrder if they don't exist
      allFields.forEach(field => {
        if (!currentOrder.includes(field)) {
          currentOrder.push(field);
        }
      });
      // Remove any fields in currentOrder that are no longer in allFields (optional, depends on desired behavior)
      currentOrder = currentOrder.filter(field => allFields.includes(field));
      setColumnOrder(currentOrder);

      // Initialize visible fields, ensuring they are a subset of allFields
      let visibleFields = getVisibleFields();
      visibleFields = visibleFields.filter(field => allFields.includes(field));      // If no visible fields are set or valid, default to a subset of allFields or a predefined minimal set
      if (visibleFields.length === 0 && allFields.length > 0) {
          // Default visible fields including actions column
          const defaultVisible = ["timestamp", "event", "source_channel_name", "dest_channel_name", "preview", "actions"];
          visibleFields = allFields.filter(f => defaultVisible.includes(f));
          if (visibleFields.length === 0) visibleFields = allFields.slice(0, Math.min(5, allFields.length));
          if (!visibleFields.includes("actions")) visibleFields.push("actions");
      }
      setVisibleFields(visibleFields);


      renderTable();
      updateTableColumnVisibility(); // Ensure columns are correctly shown/hidden
    })
    .catch(error => {
      console.error("Error fetching events data:", error);
      // Display a user-friendly error message
      const container = document.getElementById("admin-stats");
      if (container) {
        container.innerHTML = `
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">Could not load event data. Please try again later.</span>
            <p class="text-sm mt-1">Details: ${error.message}</p>
          </div>
        `;
      }
    });

  document.getElementById("openColumnChooser").addEventListener("click", showColumnChooser);
  document.getElementById("addFilterBtn").addEventListener("click", addFilter);
});

// Modal utilities (openModal, closeModal) 
function openModal(id) {
  const modal = document.getElementById(id);
  const overlay = document.getElementById(id + "-overlay");
  if (modal) {
    modal.style.display = "block";
    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
  }
  if (overlay) {
    overlay.style.display = "block";
    overlay.classList.remove("hidden");
  }
}

function closeModal(id) {
  const modal = document.getElementById(id);
  const overlay = document.getElementById(id + "-overlay");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
  }
  if (overlay) {
    overlay.style.display = "none";
    overlay.classList.add("hidden");
  }
}

function showEditOrDetails(e, eventId, isEdit = true) {
    e.preventDefault();
    e.stopPropagation();

    const event = eventsData.find(e => e.id === eventId);
    if (!event) {
        console.warn(`Event with ID ${eventId} not found`);
        return;
    }

    if (isEdit) {
        if (typeof showEditModal === 'function') {
            showEditModal(event);
        } else {
            console.error('showEditModal function not found');
        }
    } else {
        if (typeof showDetailsModal === 'function') {
            showDetailsModal(event);
        } else {
            console.error('showDetailsModal function not found');
        }
    }
}

function generateEventId(event) {
    // Create a unique ID from the event's key properties
    return `${event.source_channel}-${event.message_id}-${event.timestamp}`.replace(/[^a-zA-Z0-9-]/g, '-');
}

function processEventsData(events) {
    return events.map(event => ({
        ...event,
        id: generateEventId(event)
    }));
}

/* Event modal script */
function showEventModal(eventId) {
  const event = eventsData.find(e => e.id === eventId);
  if (!event) return;

  const modalBody = `
    <div class="space-y-4">
      <div>
        <strong class="text-gray-700">Event ID:</strong>
        <span class="text-gray-900">${event.id}</span>
      </div>
      <div>
        <strong class="text-gray-700">Source Channel:</strong>
        <span class="text-gray-900">${event.source_channel_name} (${event.source_channel})</span>
      </div>
      <div>
        <strong class="text-gray-700">Destination Channel:</strong>
        <span class="text-gray-900">${event.dest_channel_name} (${event.dest_channel})</span>
      </div>
      <div>
        <strong class="text-gray-700">Message ID:</strong>
        <span class="text-gray-900">${event.message_id}</span>
      </div>
      <div>        <strong class="text-gray-700">Event Time:</strong>
        <span class="text-gray-900">${formatTimestamp(event.timestamp)}</span>
      </div>
      <div>
        <strong class="text-gray-700">Edit Time:</strong>
        <span class="text-gray-900">${formatTimestamp(event.edit_timestamp)}</span>
      </div>
      <div>
        <strong class="text-gray-700">Status:</strong>
        <span class="text-gray-900">${event.posting_success ? 'Successful' : 'Failed'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Error Code:</strong>
        <span class="text-gray-900">${event.api_error_code || '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Error Message:</strong>
        <span class="text-gray-900">${event.exception_message || '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Media Type:</strong>
        <span class="text-gray-900">${event.media_type || '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">File Size:</strong>
        <span class="text-gray-900">${event.file_size_bytes ? (event.file_size_bytes / 1024).toFixed(2) + ' KB' : '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Original Size:</strong>
        <span class="text-gray-900">${event.original_size ? (event.original_size / 1024).toFixed(2) + ' KB' : '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Translated Size:</strong>
        <span class="text-gray-900">${event.translated_size ? (event.translated_size / 1024).toFixed(2) + ' KB' : '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Translation Time:</strong>
        <span class="text-gray-900">${event.translation_time ? event.translation_time + ' ms' : '-'}</span>
      </div>
      <div>
        <strong class="text-gray-700">Retry Count:</strong>
        <span class="text-gray-900">${event.retry_count || 0}</span>
      </div>
      <div>
        <strong class="text-gray-700">Preview:</strong>
        <div class="message-preview max-h-40 overflow-auto">
          ${event.preview ? `<div class="whitespace-pre-wrap">${event.preview}</div>` : '<em>No preview available</em>'}
        </div>
      </div>
      <div>
        <strong class="text-gray-700">Source Content:</strong>
        <div class="message-source-content max-h-40 overflow-auto">
          ${event.source_content ? `<div class="whitespace-pre-wrap">${event.source_content}</div>` : '<em>No source content available</em>'}
        </div>
      </div>
    </div>
  `;

  updateModal('event-modal', 'Event Details', modalBody, `
    <button onclick="closeModal('event-modal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>
  `);
  openModal('event-modal');
}

// Initialize event handlers for edit/details buttons
document.addEventListener('DOMContentLoaded', function() {
    const detailButtons = document.querySelectorAll('[data-action="details"]');
    const editButtons = document.querySelectorAll('[data-action="edit"]');
    
    detailButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
            const eventId = this.getAttribute('data-event-id');
            showDetailsModal(eventId);
        });
    });
    
    editButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
            const eventId = this.getAttribute('data-event-id');
            showEventModal(eventId);
        });
    });
});
  </script>
{% endblock %}
