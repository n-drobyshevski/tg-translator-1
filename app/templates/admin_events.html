{% extends 'base.html' %}
{% from 'components/modal.html' import modal %}

{% block title %}Admin Events{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
    <style>
      html, body { font-family: "Roboto", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                    "Segoe UI", Arial, sans-serif; }

      .enterprise-table thead th {
        background: #f6f7fa;
        position: sticky;
        top: 0;
        z-index: 2;
        font-weight: 500;
        color: #22304a;
        border-bottom: 2px solid #e3e8ee;
        border-right: 1px solid #e3e8ee;
        user-select: none;
        cursor: pointer;
        transition: background 0.15s;
      }
      
      /* Column-specific styles */
      .col-timestamp {
        max-width: 120px !important;
        min-width: 100px !important;
      }
      
      .col-event {
        max-width: 120px !important;
      }

      .col-source_channel, .col-dest_channel {
        max-width: 100px !important;
        min-width: 80px !important;
      }
      
      .col-source_channel_name, .col-dest_channel_name {
        max-width: 180px !important;
        min-width: 150px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .col-message_id {
        max-width: 80px !important;
        min-width: 60px !important;
        text-align: right;
      }

      .col-retry_count {
        max-width: 60px !important;
        min-width: 40px !important;
        text-align: right;
      }

      .col-posting_success {
        max-width: 70px !important;
        min-width: 70px !important;
        text-align: center;
      }      .col-source_content {
        min-width: 180px !important;
        max-width: 350px !important;
        background-color: #f9fcff; /* Very light blue background */
        font-family: 'Roboto Mono', monospace;
        font-size: 13px;
        color: #444;
      }
      
      .col-preview {
        min-width: 200px !important;
        max-width: 400px !important;
      }
      
      /* Tooltip styles */
      .col-header {
        position: relative;
      }
      
      .enterprise-table td, .enterprise-table th {
        padding: 8px 12px;
        font-size: 14px;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px; /* Default max width */
      }
      
      .enterprise-table th.sorted { background: #e9edf5; }
      .enterprise-table th:last-child,
      .enterprise-table td:last-child { border-right: none; }
      .enterprise-table tr { border-bottom: 1px solid #e3e8ee; }
      .enterprise-table tbody tr:nth-child(odd) { background: #f9fafb; }
      .enterprise-table tbody tr:hover { background: #e9edf5; transition: background 0.15s; }
      .enterprise-table td, .enterprise-table th {
        padding: 12px 18px;
        font-size: 15px;
        vertical-align: middle;
        white-space: nowrap;
      }
      .drag-handle { cursor: grab; color: #babfc6; margin-right: 6px; }
      .column-chooser-modal {
        min-width: 320px;
        border-radius: 12px;
        box-shadow: 0 4px 32px rgba(24,39,75,0.14);
      }
      .column-chooser-list { max-height: 330px; overflow-y: auto; }
      .column-chooser-li {
        background: #f6f7fa;
        border-radius: 6px;
        margin-bottom: 7px;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.13s;
        gap: 12px;
      }
      .column-chooser-li:hover { background: #eef1f7; }
      .preview-lineclamp {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal;
        word-break: break-word;
        max-width: 600px;
        min-width: 280px;
        max-height: 3.4em;
        font-family: "Roboto", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                      "Segoe UI", Arial, sans-serif;
        font-size: 0.8em;
        color: #334155;
        cursor: pointer;
        background: transparent;
        border: none;
        padding: 0;
        transition: background 0.2s;
      }
      .preview-lineclamp:hover { background: #e0e7ef; }
      .sort-arrow {
        font-size: 0.95em;
        margin-left: 5px;
        vertical-align: middle;
        color: #7c8799;
      }
      .filter-bar-row {
        background: #f4f6fa;
        border-radius: 6px;
        padding: 6px 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      @media (max-width: 900px) {
        .enterprise-table th, .enterprise-table td {
          font-size: 13px;
          padding: 8px;
        }
        .column-chooser-modal { min-width: 95vw; }
        .filter-btn-row { flex-direction: column !important; gap: 0.5rem !important; }
      }
      /* Styles for the details modal content */
      .message-fallback {
        color: #777;
        font-style: italic;
      }
      .message-text {
        white-space: pre-wrap; /* Allow wrapping */
        word-break: break-word; /* Break long words */
        font-family: 'Roboto Mono', monospace; /* Monospaced font for code/text */
        font-size: 13px;
        background-color: #fff;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .message-media {
        font-size: 12px;
        color: #555;
        margin-top: 5px;
      }
      .success-badge {
        background-color: #d1fae5; /* Light green */
        color: #065f46; /* Dark green */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .error-badge {
        background-color: #fee2e2; /* Light red */
        color: #991b1b; /* Dark red */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .info-badge {
        background-color: #e0e7ff; /* Light indigo */
        color: #3730a3; /* Dark indigo */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .error-details {
        font-size: 12px;
        color: #b91c1c; /* Slightly lighter red for details */
        margin-top: 4px;
        display: block;
      }
    </style>
{% endblock %}

{% block header %}
<div class="flex items-center w-full">
  
  <div class="flex flex-row w-full items-center justify-between">
        
  <h1 class="page-title">
    <span>Admin Events</span>
  </h1>
  </div>
</div>

{% endblock %}

{% block content %}
    <div class="container mx-auto p-3" id="admin-stats">
      <!-- Filter & Column Buttons Row -->
      <div class="filter-btn-row flex flex-row items-center gap-2 mb-3">
        <button id="addFilterBtn"
                class="bg-blue-500 text-white px-3 py-2 rounded shadow text-sm font-medium flex items-center gap-2">
          <i class="fa fa-filter"></i> Add Filter
        </button>
        <button id="openColumnChooser"
                class="bg-white border border-slate-300 hover:bg-slate-100 px-3 py-2 rounded shadow text-sm font-medium flex items-center gap-2">
          <i class="fa fa-table-columns"></i> Columns
        </button>
      </div>

      <!-- FILTER BAR (only filters added by user will appear here) -->
      <div id="filtersContainer" class="mb-4"></div>

      <!-- Table -->
      <div class="overflow-x-auto bg-white rounded shadow border border-slate-200">
        <table class="enterprise-table w-full" id="eventsTable">
          <thead>
            <tr id="eventsTableHeadRow"></tr>
          </thead>
          <tbody id="eventsTbody" class="list"></tbody>
        </table>
      </div>

      <!-- Modals rendered by macro: -->
      <div id="modals-here">
        {% set details_modal_body %}
        <div id="details-modal-content-wrapper" class="space-y-3">
            <div id="message-status" class="mb-3 text-sm"></div>
            <div>
                <h4 class="text-md font-semibold mb-1 text-slate-700">Source Message</h4>
                <div id="source-message-preview" class="p-2.5 bg-slate-50 border border-slate-200 rounded text-xs overflow-auto max-h-48 min-h-[50px]">
                    <div class="message-fallback">Loading source message...</div>
                </div>
            </div>
            <div>
                <h4 class="text-md font-semibold mb-1 text-slate-700">Translated Message (from Event)</h4>
                <div id="translated-message-preview" class="p-2.5 bg-slate-50 border border-slate-200 rounded text-xs overflow-auto max-h-48 min-h-[50px]">
                    <div class="message-fallback">Loading translated preview...</div>
                </div>
            </div>
        </div>
        {% endset %}
        {{ modal('details-modal', 'Event Details', details_modal_body, '<button onclick="closeModal(&#39;details-modal&#39;)" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>') }}
        {{ modal('preview-modal', 'Full Message Preview', '', '<button onclick="closeModal(&#39;preview-modal&#39;)" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>') }}
        {{ modal('column-chooser-modal', 'Customize Columns', '<div id="columnChooserList"></div>', '<button onclick="closeModal(&#39;column-chooser-modal&#39;)" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>') }}
        {% include 'events_edit_modal.html' %}
      </div>
    </div>
{% endblock %}


{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{{ url_for('static', filename='events_edit_modal.js') }}"></script>

  {# Data island for channel_cache JSON #}
  <script id="channelCacheJsonData" type="application/json">
    {{- channel_cache | tojson | safe -}}
  </script>

  <script>
    console.log('Admin Events page script started.');

    // This will be the globally accessible parsed cache data for this page
    let channelCacheData = {};

    try {
        const channelCacheJsonElement = document.getElementById('channelCacheJsonData');
        // Ensure element exists and textContent is not null before accessing
        const channelCacheJsonString = channelCacheJsonElement ? channelCacheJsonElement.textContent : null;

        if (channelCacheJsonString && channelCacheJsonString.trim() !== "") {
            channelCacheData = JSON.parse(channelCacheJsonString);
            // console.log("Successfully parsed channel_cache from data island:", channelCacheData); // For debugging
        } else {
            console.warn("channel_cache JSON string from data island is empty, not found, or whitespace.");
        }
    } catch (error) {
        console.error("Error parsing channel_cache JSON from data island:", error);
        const rawContent = document.getElementById('channelCacheJsonData') ? document.getElementById('channelCacheJsonData').textContent : "Element not found";
        // console.error("Raw content from data island was:", rawContent); // Be cautious with logging potentially large/sensitive data
        // channelCacheData remains {}
    }

    // Initialize cache for events_edit_modal.js if its initCache function is available
    // This replaces the previous block: var rawJsonData = ...; try { var parsedCacheData = JSON.parse(rawJsonData); initCache(parsedCacheData); ... }
    if (typeof initCache === "function") {
        initCache(channelCacheData || {}); // Pass the parsed data
    } else {
        // console.warn("initCache function (from events_edit_modal.js) not found at initial parse time."); // Optional warning
    }

/*==========================================================================================
  → GLOBAL VARIABLES & UTILITY FUNCTIONS
==========================================================================================*/
const FIELDS_KEY = "admin_stats_visible_fields_v2";
const ORDER_KEY = "admin_stats_column_order_v2";

let allFields = [], eventsData = []; 
// The 'let channelCacheData = {};' declaration and subsequent try-catch block that previously re-parsed
// '{{ channel_cache | tojson | safe }}' is removed, as 'channelCacheData' is now populated above.
// channelCacheData is already defined and populated from the data island.

let displayedEvents = []; // ← holds the current filtered+sorted list

let activeFilters = [];
let sortState = { column: "timestamp", dir: -1 };

const FILTER_OPERATORS = ["IS", "IS NOT", "EXISTS", "DOES NOT EXIST"];
let FILTER_FIELDS = [
  "timestamp", "event", "edit_timestamp", "source_channel", "source_channel_name",
  "dest_channel", "dest_channel_name", "message_id", "media_type", "file_size_bytes",
  "original_size", "translated_size", "translation_time", "retry_count",
  "posting_success", "api_error_code", "exception_message", "preview", "source_content",
  "actions"
];

function prettifyFieldName(field) {  // Short display names
  const displayNames = {
    "timestamp": "Time",
    "event": "Event",
    "edit_timestamp": "Edit Time",
    "source_channel": "Source ID",
    "source_channel_name": "Source Channel",
    "dest_channel": "Dest ID",
    "dest_channel_name": "Destination",
    "message_id": "Msg ID",
    "media_type": "Media",
    "file_size_bytes": "File Size",
    "original_size": "Orig Size",
    "translated_size": "Trans Size",
    "translation_time": "Trans Time",
    "retry_count": "Retries",
    "posting_success": "Status",
    "api_error_code": "Error Code",
    "exception_message": "Error",
    "preview": "Preview",
    "source_content": "Source",
    "actions": "Actions"
  };

  // Full names for tooltips
  const tooltips = {
    "timestamp": "When the event occurred",
    "event": "Type of event",
    "edit_timestamp": "When the event was last edited",
    "source_channel": "Source channel ID",
    "source_channel_name": "Source channel name",
    "dest_channel": "Destination channel ID",
    "dest_channel_name": "Destination channel name",
    "message_id": "Message ID",
    "media_type": "Type of media attached",
    "file_size_bytes": "Size of attached file in bytes",
    "original_size": "Original message size",
    "translated_size": "Translated message size",
    "translation_time": "Time taken to translate",
    "retry_count": "Number of retry attempts",
    "posting_success": "Whether posting succeeded",
    "api_error_code": "API error code if any",
    "exception_message": "Exception message if any",
    "preview": "Preview of translated message",
    "source_content": "Original message content",
    "actions": "Edit or view details"
  };

  const name = displayNames[field] || field;

  return {
    short: name,  // Short name for table header
    tooltip: tooltips[field] || name // Fallback tooltip to the formatted name
  };
}

function getVisibleFields() {
  const stored = localStorage.getItem(FIELDS_KEY);
  if (stored) return JSON.parse(stored);
  // Default minimal set of visible fields
  return [
    "timestamp",
    "event",
    // "source_channel", // ID might be too much for default view
    "source_channel_name",
    // "dest_channel",   // ID might be too much for default view
    "dest_channel_name",
    "message_id",
    "posting_success",
    "preview",        // Translated message from event
    "actions"         // Always include actions column
  ];
}

function setVisibleFields(arr) { 
  // Ensure actions column is always included
  if (!arr.includes("actions")) {
    arr.push("actions");
  }
  localStorage.setItem(FIELDS_KEY, JSON.stringify(arr)); 
}

function getColumnOrder() {
  const stored = localStorage.getItem(ORDER_KEY);
  // Ensure allFields is populated before filtering, or filter against a known full list initially
  const defaultOrder = allFields.length > 0 ? allFields.slice() : FILTER_FIELDS.slice();
  if (stored) {
      const parsedOrder = JSON.parse(stored);
      // Filter out any fields that might no longer exist
      return parsedOrder.filter(f => defaultOrder.includes(f));
  }
  return defaultOrder;
}
function setColumnOrder(arr) { localStorage.setItem(ORDER_KEY, JSON.stringify(arr)); }

function updateModal(id, title, body, footer) {
  const titleEl = document.getElementById(id + "-title");
  if (titleEl) titleEl.textContent = title;
  
  const bodyEl = document.querySelector("#" + id + " .modal-body");
  if (bodyEl) bodyEl.innerHTML = body;
  
  const footerEl = document.querySelector("#" + id + " .modal-footer");
  if (footerEl && footer !== undefined) footerEl.innerHTML = footer;
}

function showPreviewModal(htmlContent) { // Renamed param for clarity
  updateModal("preview-modal", "Full Message Preview",
    `<div class="bg-slate-50 border border-slate-200 rounded-lg p-3 font-roboto text-base text-gray-800" style="white-space:pre-wrap; word-break:break-word;">${htmlContent}</div>`,
    `<button onclick="closeModal('preview-modal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>`);
  openModal("preview-modal");
}

function renderColumnChooserHtml() {
  const order = getColumnOrder();
  const visibleFields = getVisibleFields();
  let html = `<div class="column-chooser-list">`;
  order.forEach(field => {
    const isVisible = visibleFields.includes(field);
    const fieldNameParts = prettifyFieldName(field); // Returns {short: ..., tooltip: ...}
    const displayName = fieldNameParts.short;
    const tooltipText = fieldNameParts.tooltip || '';
    // Use string concatenation for HTML generation to avoid issues with backticks in Jinja context
    html += 
      '<div class="column-chooser-li" data-field="' + field + '" title="' + tooltipText + '">' +
        '<div class="flex items-center gap-2">' +
          '<i class="fas fa-grip-vertical drag-handle"></i>' +
          '<label class="flex items-center gap-2 cursor-pointer">' +
            '<input type="checkbox" data-field="' + field + '" ' + (isVisible ? 'checked' : '') + ' class="form-checkbox h-4 w-4 text-blue-600">' +
            '<span class="select-none">' + displayName + '</span>' +
          '</label>' +
        '</div>' +
      '</div>';
  });
  html += '</div>';
  return html;
}

function showColumnChooser() {
  let chooserHtml = renderColumnChooserHtml();
  // Use string concatenation for HTML generation
  updateModal("column-chooser-modal", "Customize Columns", 
    '<div class="mb-3 text-sm text-gray-600">' +
      'Drag to reorder. Check to show. Default view shows essential fields.' +
     '</div>' +
     '<div id="columnChooserListContainer">' + chooserHtml + '</div>', 
    '<button onclick="applyColumnChangesAndClose()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Apply</button>' +
     '<button onclick="closeModal(&#39;column-chooser-modal&#39;)" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 ml-2">Cancel</button>');
  
  openModal("column-chooser-modal");
  
  const listContainer = document.getElementById("columnChooserListContainer");
  const actualList = listContainer.querySelector(".column-chooser-list"); // Get the actual list element

  listContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener("change", function() {
      // Changes are applied on "Apply" button click now, direct application removed from here
    });
  });

  Sortable.create(actualList, { // Target the actual list for Sortable
    handle: ".drag-handle",
    animation: 180,
    onEnd: function(evt) {
      // Order is also applied on "Apply" button click
    }
  });
}

function applyColumnChangesAndClose() {
    const listContainer = document.getElementById("columnChooserListContainer");
    const checkboxes = listContainer.querySelectorAll('input[type="checkbox"]');
    let newVisibleFields = [];
    checkboxes.forEach(cb => {
        if (cb.checked) {
            newVisibleFields.push(cb.getAttribute("data-field"));
        }
    });
    setVisibleFields(newVisibleFields);

    const orderedElements = listContainer.querySelectorAll(".column-chooser-li");
    const newOrder = Array.from(orderedElements).map(el => el.getAttribute("data-field"));
    setColumnOrder(newOrder);
    
    renderTable(); 
    updateTableColumnVisibility(); 
    closeModal('column-chooser-modal');
}


function compareValues(a, b, field) {
  if (field === "timestamp" || field === "edit_timestamp") {
    const dateA = a ? new Date(a) : new Date(0); 
    const dateB = b ? new Date(b) : new Date(0);
    return dateA - dateB;
  }
  if (field === "posting_success") {
    const valA = a === true ? 1 : (a === false ? 0 : -1); 
    const valB = b === true ? 1 : (b === false ? 0 : -1);
    return valA - valB;
  }

  const numA = parseFloat(a);
  const numB = parseFloat(b);

  if (!isNaN(numA) && !isNaN(numB) && String(a).match(/^\d+(\.\d+)?$/) && String(b).match(/^\d+(\.\d+)?$/) ) {
    return numA - numB;
  }
  
  return (String(a ?? "")).toLowerCase().localeCompare(String(b ?? "").toLowerCase());
}

function filterData(rawData) {
  return rawData.filter(event => {
    return activeFilters.every(filter => {
      const { field, operator, value } = filter;
      let eventValue = event[field];
      
      if (field === "source_content") {
          const sourceMsg = event.source_channel && event.message_id ? 
                            findCachedMessage(String(event.source_channel), String(event.message_id)) : null;
          eventValue = sourceMsg ? (sourceMsg.text || sourceMsg.caption || "") : "";
      }

      if (typeof eventValue === 'boolean') {
        eventValue = String(eventValue); 
      }
      eventValue = eventValue ?? "";


      const filterValues = value.split(",").map(v => v.trim().toLowerCase());
      const lowerEventValue = String(eventValue).toLowerCase();

      switch (operator) {
        case "IS":
          return filterValues.includes(lowerEventValue);
        case "IS NOT":
          return !filterValues.includes(lowerEventValue);
        case "EXISTS": 
          return lowerEventValue !== "";
        case "DOES NOT EXIST": 
          return lowerEventValue === "";
        default: return true;
      }
    });
  });
}

function renderTable() {
  const order = getColumnOrder();
  const visibleFields = getVisibleFields();
  
  let table = document.getElementById("eventsTable");
  if (!table) { console.error("Table element #eventsTable not found!"); return; }

  let head = table.querySelector("thead");
  if (!head) {
      head = document.createElement("thead");
      table.appendChild(head);
  }
  head.innerHTML = '<tr id="eventsTableHeadRow"></tr>'; 
  const headRow = head.querySelector("#eventsTableHeadRow");

  order.forEach(field => {
    if (!visibleFields.includes(field)) return;
    const fieldNameParts = prettifyFieldName(field);
    const th = document.createElement("th");
    // Use string concatenation for className and innerHTML
    th.className = 'col-header col-' + field;
    th.dataset.field = field;
    th.title = fieldNameParts.tooltip || fieldNameParts.short;
    th.innerHTML = fieldNameParts.short + ' <span class="sort-arrow"></span>';
    th.addEventListener("click", () => {
      if (sortState.column === field) {
        sortState.dir *= -1;
      } else {
        sortState.column = field;
        sortState.dir = 1;
      }
      displayedEvents.sort((a, b) => compareValues(a[field], b[field], field) * sortState.dir);
      if (field === "source_content") {
          displayedEvents.sort((a, b) => {
              const msgA = a.source_channel && a.message_id ? findCachedMessage(String(a.source_channel), String(a.message_id)) : null;
              const valA = msgA ? (msgA.text || msgA.caption || "") : "";
              const msgB = b.source_channel && b.message_id ? findCachedMessage(String(b.source_channel), String(b.message_id)) : null;
              const valB = msgB ? (msgB.text || msgB.caption || "") : "";
              return compareValues(valA, valB, field) * sortState.dir;
          });
      }
      renderTableBody(displayedEvents);
      updateSortArrows();
    });
    headRow.appendChild(th);
  });
  updateSortArrows(); 

  displayedEvents = filterData(eventsData);
  if (sortState.column === "timestamp" && eventsData.length > 0) {
      displayedEvents.sort((a, b) => compareValues(a.timestamp, b.timestamp, "timestamp") * sortState.dir);
  }
  renderTableBody(displayedEvents);
}

function updateSortArrows() {
  document.querySelectorAll("#eventsTableHeadRow th").forEach(th => {
    const arrow = th.querySelector(".sort-arrow");
    if (!arrow) return;
    if (th.dataset.field === sortState.column) {
      arrow.innerHTML = sortState.dir === 1 ? "▲" : "▼";
    } else {
      arrow.innerHTML = "";
    }
  });
}

function renderTableBody(data) {
  const tbody = document.getElementById("eventsTbody");
  if (!tbody) { console.error("Tbody element #eventsTbody not found!"); return; }
  tbody.innerHTML = ""; 

  const visibleFields = getVisibleFields();
  const order = getColumnOrder();

  data.forEach(event => {
    const row = tbody.insertRow();
    row.className = "event-row"; 
    row.addEventListener('click', (e) => {
        if (e.target.closest('button, a, input, .preview-lineclamp')) {
            return;
        }
        showDetailsModal(event); 
    });

    // Add cells for all visible fields
    order.forEach(field => {
      if (!visibleFields.includes(field)) return;
      const cell = row.insertCell();
      cell.className = "col-" + field;

      let cellValue = event[field];
      if (field === "posting_success") {
        cellValue = cellValue ? '<span class="success-badge">OK</span>' : '<span class="error-badge">FAIL</span>';
      } else if (field === "preview" && typeof cellValue === "string") {
        cellValue = `<button class="preview-lineclamp" onclick="event.stopPropagation(); showPreviewModal(\`${cellValue.replace(/`/g, '\\`')}\`)">${cellValue}</button>`;
      }
      cell.innerHTML = cellValue ?? "";
      
      if (cell.className.includes("col-message_id") || cell.className.includes("col-retry_count")) {
        cell.style.textAlign = "right";
      }
    });

    // Add action buttons cell
    const actionCell = row.insertCell();
    actionCell.className = "text-right whitespace-nowrap px-4";
    actionCell.style.width = "120px";
    actionCell.innerHTML = `
      <button 
        onclick="event.stopPropagation(); showEditModal(${JSON.stringify(event).replace(/"/g, '&quot;')})" 
        class="text-blue-600 hover:text-blue-800 font-medium text-sm px-2 py-1 rounded hover:bg-blue-50"
        title="Edit event">
        <i class="fas fa-edit"></i>
      </button>
      <button 
        onclick="event.stopPropagation(); showDetailsModal(${JSON.stringify(event).replace(/"/g, '&quot;')})"
        class="text-gray-600 hover:text-gray-800 font-medium text-sm px-2 py-1 rounded hover:bg-gray-50"
        title="View details">
        <i class="fas fa-info-circle"></i>
      </button>
    `;
  });
}


function updateTableColumnVisibility() {
  renderTable(); 
}

//==========================================================================================
//  → FILTERS
//==========================================================================================
function addFilter() {
  const filterId = 'filter-' + Date.now();
  // Use string concatenation for HTML generation
  const filterHtml = 
    '<div id="' + filterId + '" class="filter-bar-row p-2 border rounded mb-2 bg-slate-50">' +
      '<select class="filter-field form-select form-select-sm">' +
        FILTER_FIELDS.map(f => '<option value="' + f + '">' + prettifyFieldName(f).short + '</option>').join('') +
      '</select>' +
      '<select class="filter-operator form-select form-select-sm">' +
        FILTER_OPERATORS.map(op => '<option value="' + op + '">' + op + '</option>').join('') +
      '</select>' +
      '<input type="text" class="filter-value form-input form-input-sm flex-grow" placeholder="Value (comma-sep for IS/IS NOT)">' +
      '<button onclick="removeFilter(&#39;' + filterId + '&#39;)" class="text-red-500 hover:text-red-700 p-1 text-sm">' +
        '<i class="fa fa-trash"></i>' +
      '</button>' +
    '</div>';
  document.getElementById("filtersContainer").insertAdjacentHTML("beforeend", filterHtml);
  
  const newFilterElement = document.getElementById(filterId);
  const inputs = newFilterElement.querySelectorAll("select, input");
  inputs.forEach(input => input.addEventListener("change", applyFiltersAndRender));
  newFilterElement.querySelector(".filter-value").addEventListener("keyup", applyFiltersAndRender);


  activeFilters.push({ 
    id: filterId, 
    field: newFilterElement.querySelector(".filter-field").value, 
    operator: newFilterElement.querySelector(".filter-operator").value, 
    value: "" 
  });
  applyFiltersAndRender();
}

function removeFilter(filterId) {
  document.getElementById(filterId).remove();
  activeFilters = activeFilters.filter(f => f.id !== filterId);
  applyFiltersAndRender();
}

function applyFiltersAndRender() {
  activeFilters = Array.from(document.querySelectorAll("#filtersContainer > div")).map(filterElement => ({
    id: filterElement.id,
    field: filterElement.querySelector(".filter-field").value,
    operator: filterElement.querySelector(".filter-operator").value,
    value: filterElement.querySelector(".filter-value").value
  }));
  
  displayedEvents = filterData(eventsData);
  if (sortState.column) {
    displayedEvents.sort((a, b) => {
        let valA = a[sortState.column];
        let valB = b[sortState.column];
        if (sortState.column === "source_content") {
            const msgA = a.source_channel && a.message_id ? findCachedMessage(String(a.source_channel), String(a.message_id)) : null;
            valA = msgA ? (msgA.text || msgA.caption || "") : "";
            const msgB = b.source_channel && b.message_id ? findCachedMessage(String(b.source_channel), String(b.message_id)) : null;
            valB = msgB ? (msgB.text || msgB.caption || "") : "";
        }
        return compareValues(valA, valB, sortState.column) * sortState.dir;
    });
  }
  renderTableBody(displayedEvents);
}


//==========================================================================================
//  → INITIALIZATION
//==========================================================================================
document.addEventListener("DOMContentLoaded", () => {
  // console.log("Admin Events page script started."); // This console log is now at the top of the script
  // Initialize cacheData for the modal script
  // Ensure channelCacheData is populated before this line, or handle potential undefined state in events_edit_modal.js
  if (typeof initializeCache === "function") {
    initializeCache(channelCacheData || {}); // Uses the channelCacheData parsed from the data island
  } else {
    console.warn("initializeCache function not found. Ensure events_edit_modal.js is loaded and defines it.");
  }

  fetch("{{ url_for('admin_stats_bp.admin_stats_detail') }}")
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        console.error("Error from server:", data.error);
        alert("Error fetching events: " + data.error);
        return;
      }
      eventsData = data.events_last_100 || []; // Correctly access the array
      console.log("Fetched events data:", eventsData);

      if (eventsData.length > 0) {
        allFields = Object.keys(eventsData[0] || {});
      } else {
        // If eventsData is empty, use FILTER_FIELDS as a fallback for allFields
        // This ensures the column chooser can still be populated even with no data
        allFields = FILTER_FIELDS.slice(); 
        console.warn("No events data received, using default fields for column chooser.");
      }
      
      // Initialize or update column order based on potentially new allFields
      let currentOrder = getColumnOrder();
      // Add any new fields from allFields to the currentOrder if they don't exist
      allFields.forEach(field => {
        if (!currentOrder.includes(field)) {
          currentOrder.push(field);
        }
      });
      // Remove any fields in currentOrder that are no longer in allFields (optional, depends on desired behavior)
      currentOrder = currentOrder.filter(field => allFields.includes(field));
      setColumnOrder(currentOrder);

      // Initialize visible fields, ensuring they are a subset of allFields
      let visibleFields = getVisibleFields();
      visibleFields = visibleFields.filter(field => allFields.includes(field));
      // If no visible fields are set or valid, default to a subset of allFields or a predefined minimal set
      if (visibleFields.length === 0 && allFields.length > 0) {
          // Default to first 5 fields or a specific set
          const defaultVisible = ["timestamp", "event", "source_channel_name", "dest_channel_name", "preview"];
          visibleFields = allFields.filter(f => defaultVisible.includes(f));
          if (visibleFields.length === 0) visibleFields = allFields.slice(0, Math.min(5, allFields.length));
      }
      setVisibleFields(visibleFields);


      renderTable();
      updateTableColumnVisibility(); // Ensure columns are correctly shown/hidden
    })
    .catch(error => {
      console.error("Error fetching events data:", error);
      // Display a user-friendly error message
      const container = document.getElementById("admin-stats");
      if (container) {
        container.innerHTML = `
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">Could not load event data. Please try again later.</span>
            <p class="text-sm mt-1">Details: ${error.message}</p>
          </div>
        `;
      }
    });

  document.getElementById("openColumnChooser").addEventListener("click", showColumnChooser);
  document.getElementById("addFilterBtn").addEventListener("click", addFilter);
});

// Modal utilities (openModal, closeModal) 
function openModal(id) {
  const modal = document.getElementById(id);
  const overlay = document.getElementById(id + "-overlay");
  if (modal) {
    modal.style.display = "block";
    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
  }
  if (overlay) {
    overlay.style.display = "block";
    overlay.classList.remove("hidden");
  }
}

function closeModal(id) {
  const modal = document.getElementById(id);
  const overlay = document.getElementById(id + "-overlay");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
  }
  if (overlay) {
    overlay.style.display = "none";
    overlay.classList.add("hidden");
  }
}
  </script>
{% endblock %}
