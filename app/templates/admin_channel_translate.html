<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Channel Message Translation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
      .toggle-btn {
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <h2>Channel Message Translation</h2>
      <!-- Step 1: Select source channel -->
      <form method="post" class="mb-3">
        <label for="source_channel" class="form-label">Select source channel:</label>
        <select name="source_channel" id="source_channel" class="form-select" required>
          <option value="">-- Select --</option>
          {% for ch in channels %}
            <option value="{{ ch.id }}" {% if selected_channel_id == ch.id %}selected{% endif %}>
              {{ ch.name }} ({{ ch.id }}){% if ch.is_en %} [EN]{% endif %}
            </option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary mt-2">Load Messages</button>
      </form>
      <!-- Step 2: Select message -->
      {% if recent_messages %}
        <form method="post" class="mb-3">
          <input type="hidden" name="source_channel" value="{{ selected_channel_id }}">
          <label for="message_id" class="form-label">Select message:</label>
          <select name="message_id" id="message_id" class="form-select" required>
            {% for msg in recent_messages %}
              <option value="{{ msg.id }}" {% if selected_message_id == msg.id|string %}selected{% endif %}>
                {{ msg.timestamp }} | {{ msg.text|truncate(60) }}
              </option>
            {% endfor %}
          </select>
          {% if not selected_channel_is_en %}
            <button type="submit" class="btn btn-success mt-2">Translate</button>
          {% else %}
            <div class="alert alert-warning mt-2">Translation is not available for EN channels. You can only delete messages.</div>
          {% endif %}
          <button type="submit" name="action" value="delete" class="btn btn-danger mt-2"
            onclick="return confirm('Are you sure you want to delete this message?');">
            Delete Selected Message
          </button>
        </form>
      {% endif %}
      <!-- Step 3: Show translation result -->
      {% if translation_result %}
        <div class="d-flex align-items-center mt-4 mb-2">
          <h4 class="mb-0 flex-grow-1">Translation Result</h4>
          <button type="button"
                  class="btn btn-link text-primary ms-auto"
                  onclick="const el=document.getElementById('raw-html-content'); el.style.display = (el.style.display == 'none' ? 'block' : 'none');">
            Toggle Raw HTML
          </button>
        </div>
        <div class="mb-3">
          <div id="raw-html-content" style="white-space: pre-wrap; border:1px solid #ccc; padding:1em; margin-bottom:1em;">
            {{ raw_html_result }}
          </div>
          <div class="border rounded bg-light p-3">
            <div>Rendered HTML:</div>
            <div style="margin-top:0.5em;">{{ rendered_html_result|safe }}</div>
          </div>
        </div>
        <hr>
        <!-- Step 4: Select target channel and post -->
        <form method="post" class="mb-3">
          <input type="hidden" name="source_channel" value="{{ selected_channel_id }}">
          <input type="hidden" name="message_id" value="{{ selected_message_id }}">
          <label for="target_channel" class="form-label">Select target channel:</label>
          <select name="target_channel" id="target_channel" class="form-select" required>
            {% for ch in target_channels %}
              <option value="{{ ch.type }}" {% if selected_target_type == ch.type %}selected{% endif %}>{{ ch.name }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-warning mt-2">Post Translation</button>
        </form>
        {% if post_result %}
          <div class="alert alert-info mt-2">{{ post_result }}</div>
        {% endif %}
        {% if delete_result %}
          <div class="alert alert-warning mt-2">{{ delete_result }}</div>
        {% endif %}
      {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>